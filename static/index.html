<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資産管理システム</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="header__title">資産管理システム</h1>
            <p class="header__subtitle">ポートフォリオ分析ダッシュボード</p>
        </div>
    </header>

    <main class="container">
        <section class="section">
            <h2 class="section__title">資産配分テーブル</h2>
            <div class="card">
                <div class="card__body">
                    <table class="table" id="assetTable">
                        <thead class="table__header">
                            <tr>
                                <th>資産区分</th>
                                <th class="text-center">金額</th>
                                <th class="text-center">割合</th>
                                <th class="text-center">目標金額</th>
                                <th class="text-center">目標割合</th>
                            </tr>
                        </thead>
                        <tbody class="table__body">
                            <!-- データ行がここに入る -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="grid grid--2col">
            <section class="section">
                <h2 class="section__title">資産配分グラフ</h2>
                <div class="card">
                    <div class="card__body">
                        <div class="chart-container">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2 class="section__title">ファイルアップロード</h2>
                <div class="card">
                    <div class="card__body">
                        <div id="drop-area" class="drop-area">
                            <p class="drop-area__text">CSVファイルをここにドロップ</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <script>
        // グラフインスタンスを保持するグローバル変数
        let myChart = null;

        /**
         * サーバーから資産データを取得し、テーブルとグラフを更新する関数
         */
        async function fetchFlights() {
            try {
                // APIエンドポイントから資産データを取得
                const res = await fetch('/api/view_assets');
                const assets = await res.json();

                // テーブルの更新
                const tbody = document.querySelector('#assetTable .table__body');
                tbody.innerHTML = ''; // 既存のテーブル行をクリア

                // グラフ用のデータ配列を初期化
                const chartLabels = [];  // 資産名のラベル
                const chartData = [];    // 割合のデータ
                const chartColors = [    // グラフの色設定（10色のパレット）
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
                ];

                // 取得した資産データを1行ずつ処理
                assets.forEach((asset, index) => {
                    // テーブル行の作成
                    const tr = document.createElement('tr');

                    // 資産名のセル
                    const td1 = document.createElement('td');
                    td1.textContent = asset.asset_name;

                    // 金額のセル（右寄せ）
                    const td2 = document.createElement('td');
                    td2.textContent = asset.amount;
                    td2.className = 'text-right';

                    // 現在割合のセル（右寄せ）
                    const td3 = document.createElement('td');
                    td3.textContent = asset.ratio;
                    td3.className = 'text-right';

                    // 目標金額のセル（右寄せ）
                    const td4 = document.createElement('td');
                    td4.textContent = asset.target_amount;
                    td4.className = 'text-right';

                    // 目標割合のセル（右寄せ）
                    const td5 = document.createElement('td');
                    td5.textContent = asset.target_ratio;
                    td5.className = 'text-right';

                    // セルを行に追加
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tr.appendChild(td3);
                    tr.appendChild(td4);
                    tr.appendChild(td5);

                    // 行をテーブルに追加
                    tbody.appendChild(tr);

                    // 合計行以外をグラフデータに追加
                    if (asset.asset_name !== '合計金額') {
                        chartLabels.push(asset.asset_name);
                        // パーセンテージ記号を除去して数値に変換（例: "25%" → 25）
                        const ratioValue = parseFloat(asset.ratio.replace('%', ''));
                        chartData.push(ratioValue);
                    }
                });

                // グラフの更新を実行
                updateChart(chartLabels, chartData, chartColors);
            } catch (error) {
                console.error('データ取得エラー:', error);
            }
        }

        /**
         * Chart.jsを使用してグラフを更新する関数
         * @param {Array} labels - グラフのラベル配列
         * @param {Array} data - グラフのデータ配列
         * @param {Array} colors - グラフの色配列
         */
        function updateChart(labels, data, colors) {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // 既存のグラフがあれば破棄してメモリリークを防ぐ
            if (myChart) {
                myChart.destroy();
            }

            // データが空の場合のハンドリング
            if (labels.length === 0 || data.length === 0) {
                // プレースホルダー用のグラフを作成
                myChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['データなし'],
                        datasets: [{
                            label: '資産配分',
                            data: [100],
                            backgroundColor: ['#e5e7eb'], // グレー色
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false  // 凡例を非表示
                            },
                            tooltip: {
                                enabled: false  // ツールチップを無効化
                            }
                        }
                    }
                });
                return;
            }

            // 実際のデータでグラフを作成
            myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '資産配分',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length), // 必要な分だけ色を使用
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,  // 丸い点スタイル
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                // ツールチップの表示内容をカスタマイズ
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ページ読み込み完了時に初期データを取得
        window.onload = fetchFlights;
    </script>

    <script>
        /**
         * ファイルドラッグ&ドロップ処理の初期化
         */
        const dropArea = document.getElementById("drop-area");

        /**
         * ファイルがドラッグされた時の処理
         * ドロップエリアの見た目を変更して、ドロップ可能であることを示す
         */
        dropArea.addEventListener("dragover", (e) => {
            e.preventDefault(); // デフォルトのドラッグ処理を無効化
            dropArea.classList.add('drop-area--active');
        });

        /**
         * ドラッグが離れた時の処理
         * ドロップエリアの見た目を元に戻す
         */
        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove('drop-area--active');
        });

        /**
         * ファイルがドロップされた時の処理
         * CSVファイルをサーバーにアップロードし、処理結果を表示
         */
        dropArea.addEventListener("drop", (e) => {
            e.preventDefault(); // デフォルトのドロップ処理を無効化
            dropArea.classList.remove('drop-area--active');

            // ドロップされたファイルを取得
            const files = e.dataTransfer.files;
            
            // FormDataオブジェクトを作成してファイルを追加
            const formData = new FormData();
            formData.append("file", files[0]);

            // サーバーにファイルをアップロード
            fetch("/upload", {
                method: "POST",
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("アップロード失敗")
                }
                return response.text();
            })
            .then(text => {
                console.log("サーバーからの応答:", text);
                alert("サーバー応答: " + text);
                // アップロード成功後、最新データでテーブルとグラフを更新
                fetchFlights();
            })
            .catch(err => {
                console.error("エラー:", err);
                alert("エラー: " + err.message);
            });
        });
    </script>
</body>
</html>
